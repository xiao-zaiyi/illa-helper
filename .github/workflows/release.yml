name: ğŸš€ Release Build and Publish
permissions:
  contents: write # æ˜ç¡®æŒ‡å®šå†™æƒé™ï¼Œç”¨äºåˆ›å»º Release

on:
  push:
    tags:
      - 'v*.*.*' # è§¦å‘æ¡ä»¶ï¼šç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v1.8.0)

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¿…é¡»è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿ git log èƒ½æ­£å¸¸å·¥ä½œ

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # 4. éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
      - name: âœ… Validate version consistency
        run: |
          # GITHUB_REF_NAME å˜é‡ç›´æ¥æä¾›äº†æ ‡ç­¾åï¼Œä¾‹å¦‚ v1.8.0
          TAG_NAME=${{ github.ref_name }}
          # ç§»é™¤ v å‰ç¼€ä»¥è·å–ç‰ˆæœ¬å·
          TAG_VERSION=${TAG_NAME#v}
          echo "Tag name: $TAG_NAME"
          echo "Tag version: $TAG_VERSION"

          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package.json version: $PACKAGE_VERSION"

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ Error: Tag version ($TAG_VERSION) does not match package.json version ($PACKAGE_VERSION)."
            exit 1
          fi

          echo "âœ… Version validation passed: $TAG_VERSION"
          # å°†ç‰ˆæœ¬å·å­˜å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV

      # 5. ä»£ç æ£€æŸ¥
      - name: ğŸ” Code quality checks
        run: |
          npm run compile
          npm run check
          npm run lint

      # 6. æ„å»ºæ‰€æœ‰å¹³å°çš„æ‰©å±•åŒ…
      - name: ğŸ—ï¸ Build extensions for all platforms
        run: |
          echo "ğŸš€ Starting to build extension packages..."
          npm run zip:all
          echo "ğŸ“ Build artifacts list:"
          ls -la .output/*.zip

      # 7. éªŒè¯æ„å»ºäº§ç‰©
      - name: âœ… Validate build artifacts
        run: |
          echo "ğŸ” Validating build artifacts..."
          required_files=(
            ".output/illa-helper-${{ env.VERSION }}-chrome.zip"
            ".output/illa-helper-${{ env.VERSION }}-firefox.zip"
            ".output/illa-helper-${{ env.VERSION }}-safari.zip"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Error: Missing build artifact: $file"
              exit 1
            else
              echo "âœ… Found artifact: $file ($(du -h "$file" | cut -f1))"
            fi
          done
          echo "ğŸ‰ All build artifacts validated successfully!"

      # 8. ç”Ÿæˆ Release Notes
      - name: ğŸ“ Generate Release Notes
        run: |
          VERSION=${{ env.VERSION }}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "ğŸ“‹ Generating changelog from $PREVIOUS_TAG to ${{ github.ref_name }}..."
            COMMITS=$(git log --pretty=format:"%s (%h)" $PREVIOUS_TAG..HEAD)
          else
            echo "ğŸ“‹ No previous tag found. This is the first release."
            COMMITS=$(git log --pretty=format:"%s (%h)" HEAD -50)
          fi

          if [ -z "$COMMITS" ]; then
            RELEASE_NOTES="- ç‰ˆæœ¬æ›´æ–°"
          else
            RELEASE_NOTES=$(echo "$COMMITS" | awk '
              BEGIN {
                FS = "[:ï¼š]";
                order_count = 8;
                order[1] = "feat";     headers["feat"]     = "âœ¨ Features";
                order[2] = "fix";      headers["fix"]      = "ğŸ› Bug Fixes";
                order[3] = "perf";     headers["perf"]     = "âš¡ï¸ Performance";
                order[4] = "refactor";  headers["refactor"]  = "â™»ï¸ Refactoring";
                order[5] = "docs";     headers["docs"]     = "ğŸ“ Documentation";
                order[6] = "style";    headers["style"]    = "ğŸ’„ Styles";
                order[7] = "test";     headers["test"]     = "âœ… Testing";
                order[8] = "chore";    headers["chore"]    = "ğŸ“¦ Chores";
              }
              {
                full_message = $0;
                if (NF < 2) {
                  groups["other"] = groups["other"] ? groups["other"] "\n- " full_message : "- " full_message;
                  next;
                }
                type_field = $1;
                gsub(/^[ \t]+|[ \t]+$/, "", type_field);
                match(type_field, /^[a-zA-Z]+/);
                type = tolower(substr(type_field, RSTART, RLENGTH));
                is_known_type = 0;
                for (i=1; i<=order_count; i++) { if (order[i] == type) { is_known_type = 1; break; } }
                if (is_known_type == 0) {
                  groups["other"] = groups["other"] ? groups["other"] "\n- " full_message : "- " full_message;
                } else {
                  groups[type] = groups[type] ? groups[type] "\n- " full_message : "- " full_message;
                }
              }
              END {
                for (i = 1; i <= order_count; i++) {
                  type = order[i];
                  if (groups[type]) {
                    if (output != "") { output = output "\n" }
                    output = output sprintf("### %s\n%s", headers[type], groups[type]);
                  }
                }
                if (groups["other"]) {
                  if (output != "") { output = output "\n\n" }
                  output = output sprintf("### miscellaneous\n%s", groups["other"]);
                }
                print output;
              }
            ')
          fi

          # ä½¿ç”¨ GITHUB_REF_NAME è®¾ç½®æ›´å‹å¥½çš„ä¸»æ ‡é¢˜
          cat << EOF > release_notes.md
          # Release ${{ github.ref_name }}

          $RELEASE_NOTES
          EOF

          echo "ğŸ“„ Release Notes Preview:"
          echo "---"
          cat release_notes.md
          echo "---"

      # 9. åˆ›å»º GitHub Release å¹¶ä¸Šä¼ èµ„äº§
      - name: ğŸ Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ä½¿ç”¨ github.ref_name ä½œä¸ºæ ‡ç­¾åï¼Œå®ƒåŒ…å«äº† "v" å‰ç¼€ (e.g., v1.8.0)
          gh release create "${{ github.ref_name }}" \
            --latest \
            --title "Release ${{ github.ref_name }}" \
            --notes-file release_notes.md \
            .output/illa-helper-${{ env.VERSION }}-chrome.zip \
            .output/illa-helper-${{ env.VERSION }}-firefox.zip \
            .output/illa-helper-${{ env.VERSION }}-safari.zip

      # 10. å‘å¸ƒæˆåŠŸé€šçŸ¥
      - name: ğŸ‰ Release completed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸŠ Release successful!"
          # åŒæ ·ï¼Œä½¿ç”¨ github.ref_name æ¥è·å– release URL
          RELEASE_URL=$(gh release view "${{ github.ref_name }}" --json url -q .url)
          echo "ğŸ“¦ Release URL: $RELEASE_URL"
          echo "ğŸ·ï¸ Version: ${{ github.ref_name }}"
