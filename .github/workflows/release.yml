name: ğŸš€ Release Build and Publish
permissions: write-all
on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v1.8.0)

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
      - name: âœ… Validate version consistency
        run: |
          # è·å–æ ‡ç­¾ç‰ˆæœ¬ï¼ˆç§»é™¤ v å‰ç¼€ï¼‰
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "æ ‡ç­¾ç‰ˆæœ¬: $TAG_VERSION"
          
          # ä» package.json è·å–ç‰ˆæœ¬å·
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package.json ç‰ˆæœ¬: $PACKAGE_VERSION"
          
          # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦ä¸€è‡´
          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ é”™è¯¯: æ ‡ç­¾ç‰ˆæœ¬ ($TAG_VERSION) ä¸ package.json ç‰ˆæœ¬ ($PACKAGE_VERSION) ä¸ä¸€è‡´"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: $TAG_VERSION"
          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV

      # ç±»å‹æ£€æŸ¥
      - name: ğŸ” TypeScript check
        run: npm run compile

      # ä»£ç è´¨é‡æ£€æŸ¥
      - name: ğŸ§¹ Format and lint check
        run: |
          npm run check
          npm run lint

      # æ„å»ºæ‰€æœ‰å¹³å°çš„æ‰©å±•åŒ…
      - name: ğŸ—ï¸ Build extensions for all platforms
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºæ‰©å±•åŒ…..."
          npm run zip:all
          
          echo "ğŸ“ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          ls -la .output/*.zip

      # éªŒè¯æ„å»ºäº§ç‰©
      - name: âœ… Validate build artifacts
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          
          # æ£€æŸ¥å¿…éœ€çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          required_files=(
            ".output/illa-helper-${{ env.VERSION }}-chrome.zip"
            ".output/illa-helper-${{ env.VERSION }}-firefox.zip"
            ".output/illa-helper-${{ env.VERSION }}-safari.zip"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ é”™è¯¯: ç¼ºå°‘æ„å»ºæ–‡ä»¶ $file"
              exit 1
            else
              echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $file ($(du -h "$file" | cut -f1))"
            fi
          done
          
          echo "ğŸ‰ æ‰€æœ‰æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡!"

      # ç”Ÿæˆ Release Notes
      - name: ğŸ“ Generate Release Notes
        id: release_notes
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "ğŸ“‹ ç”Ÿæˆä» $PREVIOUS_TAG åˆ° v${{ env.VERSION }} çš„æ›´æ–°æ—¥å¿—..."
            
            # ç”Ÿæˆæäº¤æ—¥å¿—
            RELEASE_NOTES=$(git log --pretty=format:"* %s (%h)" $PREVIOUS_TAG..HEAD | head -20)
            
            if [ -z "$RELEASE_NOTES" ]; then
              RELEASE_NOTES="* ç‰ˆæœ¬æ›´æ–°è‡³ v${{ env.VERSION }}"
            fi
          else
            echo "ğŸ“‹ é¦–æ¬¡å‘å¸ƒï¼Œç”ŸæˆåŸºç¡€å‘å¸ƒè¯´æ˜..."
            RELEASE_NOTES="* åˆå§‹ç‰ˆæœ¬å‘å¸ƒ v${{ env.VERSION }}"
          fi
          
          # ç»„åˆå®Œæ•´çš„ Release Notes
          cat << EOF > release_notes.md
          ## ğŸ‰ æµ¸å…¥å¼å­¦è¯­è¨€åŠ©æ‰‹ v${{ env.VERSION }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Chrome æµè§ˆå™¨**: ä¸‹è½½ \`illa-helper-${{ env.VERSION }}-chrome.zip\`
          - **Firefox æµè§ˆå™¨**: ä¸‹è½½ \`illa-helper-${{ env.VERSION }}-firefox.zip\`  
          - **Safari æµè§ˆå™¨**: ä¸‹è½½ \`illa-helper-${{ env.VERSION }}-safari.zip\`
          
          ### ğŸ”„ æ›´æ–°å†…å®¹
          $RELEASE_NOTES
          
          ### ğŸ“¥ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”æµè§ˆå™¨çš„ zip æ–‡ä»¶
          2. è§£å‹åˆ°æœ¬åœ°ç›®å½•
          3. åœ¨æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢åŠ è½½è§£å‹åçš„æ–‡ä»¶å¤¹
          
          ---
          ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå‘å¸ƒ
          EOF
          
          echo "ğŸ“„ Release Notes é¢„è§ˆ:"
          cat release_notes.md

      # åˆ›å»º GitHub Release
      - name: ğŸ Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.VERSION }}
          release_name: "ğŸš€ æµ¸å…¥å¼å­¦è¯­è¨€åŠ©æ‰‹ v${{ env.VERSION }}"
          body_path: release_notes.md
          draft: false
          prerelease: false

      # ä¸Šä¼  Chrome æ‰©å±•åŒ…
      - name: ğŸ“¤ Upload Chrome Extension
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: .output/illa-helper-${{ env.VERSION }}-chrome.zip
          asset_name: illa-helper-${{ env.VERSION }}-chrome.zip
          asset_content_type: application/zip

      # ä¸Šä¼  Firefox æ‰©å±•åŒ…
      - name: ğŸ“¤ Upload Firefox Extension
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: .output/illa-helper-${{ env.VERSION }}-firefox.zip
          asset_name: illa-helper-${{ env.VERSION }}-firefox.zip
          asset_content_type: application/zip

      # ä¸Šä¼  Safari æ‰©å±•åŒ…
      - name: ğŸ“¤ Upload Safari Extension
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: .output/illa-helper-${{ env.VERSION }}-safari.zip
          asset_name: illa-helper-${{ env.VERSION }}-safari.zip
          asset_content_type: application/zip

      # å‘å¸ƒæˆåŠŸé€šçŸ¥
      - name: ğŸ‰ Release completed
        run: |
          echo "ğŸŠ å‘å¸ƒå®Œæˆ!"
          echo "ğŸ“¦ Release URL: ${{ steps.create_release.outputs.html_url }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: v${{ env.VERSION }}"
          echo "ğŸ“ å·²ä¸Šä¼ çš„æ‰©å±•åŒ…:"
          echo "  âœ… Chrome: illa-helper-${{ env.VERSION }}-chrome.zip"
          echo "  âœ… Firefox: illa-helper-${{ env.VERSION }}-firefox.zip"
          echo "  âœ… Safari: illa-helper-${{ env.VERSION }}-safari.zip" 